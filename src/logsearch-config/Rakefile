require 'erb'
require 'rake'

# Clean tasks
task :clean do
  FileUtils.mkdir_p('target')
  FileUtils.rm_rf(Dir.glob('target/*'))
end

# Build tasks
desc "Builds Logstash filters"
task :build_logstash_filters => :clean do
  build_erb 'src/logstash-filters/default.conf.erb', 'target/logstash-filters-default.conf'
end

desc "Builds Kibana objects"
task :build_kibana_objects => :clean do
  build_erb 'src/kibana-objects/kibana-objects-bulk-json.erb', 'target/kibana-objects-bulk-json'
end

desc "Builds Elasticsearch mappings"
task :build_es_mappings => :clean do
  build_erb 'src/es-mappings/logs-template.json.erb', 'target/logs-template.json'
end

desc "Builds all logsearch configs"
task :build => :clean do
  build_erb 'src/logstash-filters/default.conf.erb', 'target/logstash-filters-default.conf'
  build_erb 'src/kibana-objects/kibana-objects-bulk-json.erb', 'target/kibana-objects-bulk-json'
  build_erb 'src/es-mappings/logs-template.json.erb', 'target/logs-template.json'
end

def build_erb(source_erb_file, target_file)
  puts "===> Building ..."
  compile_erb source_erb_file, target_file

  puts "===> Artifacts:"
  puts `find target`
end

# Test tasks
desc "Runs unit tests against filters"
task :utest, [:rspec_files] => :build_logstash_filters do |t, args|
  args.with_defaults(:rspec_files => "$(find test -name *-spec.rb ! -name *-it-spec.rb)")
  puts "===> Testing ..."
  sh %Q[ vendor/logstash/bin/rspec #{args[:rspec_files]} --colour ]
end

desc "Runs integration tests against filters"
task :itest, [:rspec_files] => :build_logstash_filters do |t, args|
  args.with_defaults(:rspec_files => "$(find test -name *-it-spec.rb)")
  puts "===> Integration Testing ..."
  sh %Q[ vendor/logstash/bin/rspec #{args[:rspec_files]} --colour ]
end

desc "Runs JSON validation tests"
task :json, [:json_files] => :build do |t, args|
  args.with_defaults(:json_files => "$(find target -name *.json)")
  puts "===> Validating JSON data ..."
  sh %Q[ jsonlint #{args[:json_files]} ]
end

desc "Runs YAML validation tests"
task :yaml, [:yaml_files] => :build do |t, args|
  args.with_defaults(:yaml_files => "$(find ../.. -path ../../src -prune -o -name '*.yml' -print)")
  puts "===> Validating YAML data ..."
  sh %Q[ yaml-lint #{args[:yaml_files]} ]
end

task default: [
  :utest,
  :itest,
  :json,
  :yaml
]

def unescape_embedded_doublequote(str)
  str.gsub("_eQT_", '\\\\\\\\\"')
end

def unescape_embedded_newline(str)
  str.gsub('_eLF_', '\\\\\\\\n')
end

def compile_erb(source_file, dest_file)
  if File.extname(source_file) == '.erb'
    output = ERB.new(File.read(source_file)).result(binding)
    output = unescape_embedded_doublequote(output)
    output = unescape_embedded_newline(output)
    File.write(dest_file, output)
    puts "ERB #{source_file} -> #{dest_file}"
  else
    cp source_file, dest_file
  end
end
